{% extends 'tienda/base.html' %}

{% block title %}Productos - {{ categoria.nombre }}{% endblock %}

{% block extra_css %}
<style>
  .table-responsive {
    overflow-x: auto;
  }

  .table th:first-child,
  .table td:first-child {
    position: sticky;
    left: 0;
    background-color: #343a40;
    color: white;
    z-index: 3;
    min-width: 60px;
  }

  .table th:nth-child(2),
  .table td:nth-child(2) {
    min-width: 80px;
  }

  .table th:nth-child(3),
  .table td:nth-child(3) {
    position: sticky;
    left: 60px;
    z-index: 2;
    min-width: 150px;
  }

  tbody tr:hover {
    background-color: #f1f1f1;
  }
</style>
{% endblock %}

{% block content %}


<div class="container mt-5 mb-5">
  <div class="row align-items-center text-center text-md-start">
    <!-- Botón volver -->
    <div class="col-4 d-flex justify-content-start">
      <a href="{% url 'listar_categorias' %}" class="btn btn-outline-secondary btn-sm w-100 w-md-auto">
        ← Volver
      </a>
    </div>

    <!-- Título centrado -->
    <div class="col-4 d-flex justify-content-center">
      <h2 class="mb-0 fs-3 fs-md-2 fw-bold text-uppercase">
        {{ categoria.nombre }}
      </h2>
    </div>

    <!-- Botón agregar -->
    <div class="col-4 d-flex justify-content-end">
      <button type="button" class="btn btn-outline-success btn-sm w-100 w-md-auto" data-bs-toggle="modal"
        data-bs-target="#crearProductoModal">
        <i class="bi bi-plus-lg"></i> Agregar
      </button>
    </div>
  </div>
</div>





<div class="container d-flex justify-content-between align-items-end mb-3 gap-3 flex-wrap mb-5">
  <div class="flex-grow-1">
    <input type="text" id="filtroProductos" class="form-control" placeholder="Buscar productos...">
  </div>

  <div>
    <label for="filtroGenero" class="form-label mb-1">Género:</label>
    <select id="filtroGenero" class="form-select form-select-sm w-auto">
      <option value="">Todos</option>
      {% for genero in generos %}
      <option value="{{ genero }}">{{ genero }}</option>
      {% endfor %}



    </select>
  </div>

  <div class="d-flex gap-2">
    <button id="btnPrecioAlto" type="button" class="btn btn-outline-primary btn-sm">Precio Alto</button>
    <button id="btnPrecioBajo" type="button" class="btn btn-outline-success btn-sm">Precio Bajo</button>
  </div>
</div>



{% if productos %}
<div class="table-responsive  px-md-5">
  <table class="table table-striped table-hover align-middle">
    <thead class="table-dark text-center">
      <tr>
        <th>ID</th>
        <th>Foto</th>
        <th>Nombre</th>
        <th>Marca</th>
        <th>Tipo Fragancia</th>
        <th>Género</th>
        <th>Descripción</th>
        <th>Precio (€)</th>
        <th>Stock</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody class="text-center">
      {% for producto in productos %}
      <tr>
        <td>{{ forloop.counter }}</td>

        <td>
          {% if producto.foto %}
          <img src="{{ producto.foto.url }}" alt="{{ producto.nombre }}" style="height: 50px; width: auto;">
          {% else %}
          <span class="text-muted">Sin foto</span>
          {% endif %}
        </td>
        <td>
          <a href="#" data-bs-toggle="modal" data-bs-target="#detalleProductoModal{{ producto.id }}">
            {{ producto.nombre }}
          </a>
        </td>
        <td>
          {% if producto.marca.nombre %}
          {{ producto.marca.nombre }}
          {% else %}
          <span class="text-muted fst-italic">Sin marca</span>
          {% endif %}
        </td>
        <td>
          {% if producto.get_tipo_fragancia_display %}
          {{ producto.get_tipo_fragancia_display }}
          {% else %}
          <span class="text-muted fst-italic">Sin tipo</span>
          {% endif %}
        </td>
        <td>
          {% if producto.genero.nombre %}
          {{ producto.genero.nombre }}
          {% else %}
          <span class="text-muted fst-italic">Sin género</span>
          {% endif %}
        </td>
        <td>
          {% if producto.descripcion %}
          {{ producto.descripcion|truncatechars:50 }}
          {% else %}
          <span class="text-muted fst-italic">Sin descripción</span>
          {% endif %}
        </td>
        <td>{{ producto.precio }}</td>
        <td>{{ producto.stock }}</td>
        <td>
          <div class="d-flex flex-wrap gap-1">
            <a href="#" data-bs-toggle="modal" data-bs-target="#detalleProductoModal{{ producto.id }}"
              title="Ver detalle"
              class="btn btn-sm btn-outline-primary d-flex align-items-center justify-content-center"
              style="width: 38px; height: 38px;">
              <i class="bi bi-eye-fill" style="font-size: 1.2rem;"></i>
            </a>

            <a href="{% url 'producto_editar' producto.id %}"
              class="btn btn-sm btn-outline-warning d-flex align-items-center justify-content-center" title="Modificar"
              style="width: 38px; height: 38px;">
              <i class="bi bi-pencil-fill" style="font-size: 1.2rem;"></i>
            </a>

            <a href="#" data-bs-toggle="modal" data-bs-target="#borrarProductoModal{{ producto.id }}" title="Eliminar"
              class="btn btn-sm btn-outline-danger d-flex align-items-center justify-content-center"
              style="width: 38px; height: 38px;">
              <i class="bi bi-trash-fill" style="font-size: 1.2rem;"></i>
            </a>
          </div>
        </td>
      </tr>

      <!-- Modal detalle rápido -->
      <div class="modal fade" id="detalleProductoModal{{ producto.id }}" tabindex="-1"
        aria-labelledby="detalleProductoLabel{{ producto.id }}" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
          <div class="modal-content rounded-4 shadow-lg">
            <div class="modal-header border-0">
              <h5 class="modal-title fs-4 fw-bold" id="detalleProductoLabel{{ producto.id }}">
                Detalle del Producto
              </h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
              <div class="row">
                <div class="col-md-5 d-flex align-items-center justify-content-center mb-4 mb-md-0">
                  {% if producto.foto %}
                  <img src="{{ producto.foto.url }}" alt="{{ producto.nombre }}" class="img-fluid rounded shadow-sm"
                    style="max-height: 250px; object-fit: contain;">
                  {% else %}
                  <div class="text-muted fst-italic">Sin foto disponible</div>
                  {% endif %}
                </div>
                <div class="col-md-7">
                  <h2 class="fw-bold mb-3">{{ producto.nombre }}</h2>
                  <h3 class="text-success € fw-semibold mb-3"> Precio: {{ producto.precio|floatformat:2 }}€</h3>
                  <div class="mb-3">
                    <span class="badge bg-primary fs-5">Stock: {{ producto.stock }}</span>
                  </div>
                  <ul class="list-unstyled mb-4">
                    <li><strong>ID:</strong> {{ producto.id }}</li>
                    {% if producto.marca.nombre %}
                    <li><strong>Marca:</strong> {{ producto.marca.nombre }}</li>
                    {% endif %}
                    {% if producto.get_tipo_fragancia_display %}
                    <li><strong>Tipo de Fragancia:</strong> {{ producto.get_tipo_fragancia_display }}</li>
                    {% endif %}
                    {% if producto.genero.nombre %}
                    <li><strong>Género:</strong> {{ producto.genero.nombre }}</li>
                    {% endif %}
                  </ul>
                  {% if producto.descripcion %}
                  <hr>
                  <h5 class="mb-2">Descripción</h5>
                  <p class="text-muted">{{ producto.descripcion }}</p>
                  {% endif %}
                </div>
              </div>
            </div>
            <div class="modal-footer border-0">
              <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal de confirmación de eliminación -->
      <div class="modal fade" id="borrarProductoModal{{ producto.id }}" tabindex="-1"
        aria-labelledby="borrarProductoLabel{{ producto.id }}" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content rounded-4 shadow">
            <div class="modal-header border-0">
              <h5 class="modal-title text-danger fw-bold" id="borrarProductoLabel{{ producto.id }}">Confirmar
                eliminación</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
              <p class="mb-0">¿Estás seguro de que deseas eliminar el producto <strong>{{ producto.nombre }}</strong>?
              </p>
            </div>
            <div class="modal-footer border-0">
              <form method="post" action="{% url 'producto_eliminar' producto.id %}">
                {% csrf_token %}
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="submit" class="btn btn-danger">Eliminar</button>
              </form>
            </div>
          </div>
        </div>
      </div>

      {% endfor %}
    </tbody>
  </table>
</div>
{% else %}
<p class="text-muted">No hay productos en esta categoría.</p>
{% endif %}
<p id="mensajeNoResultados" style="display: none; color: red; text-align: center;">
  No se encontraron productos.
</p>



<!-- Modal para crear producto -->
<div class="modal fade" id="crearProductoModal" tabindex="-1" aria-labelledby="crearProductoLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content rounded-4 shadow-lg">
      <div class="modal-header border-0">
        <h5 class="modal-title fw-bold" id="crearProductoLabel">Crear Producto</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <form method="post" enctype="multipart/form-data" id="formCrearProducto"
          action="{% url 'producto_crear' categoria.id %}">
          {% csrf_token %}
          {{ form.as_p }}
        </form>
      </div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="submit" form="formCrearProducto" class="btn btn-success">Crear</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const filtroInput = document.getElementById('filtroProductos');
    const filtroGenero = document.getElementById('filtroGenero');
    const btnPrecioAlto = document.getElementById('btnPrecioAlto');
    const btnPrecioBajo = document.getElementById('btnPrecioBajo');
    const tabla = document.querySelector('tbody');
    const filas = tabla ? Array.from(tabla.querySelectorAll('tr')) : [];
    const mensajeNoResultados = document.getElementById('mensajeNoResultados');

    function filtrarProductos() {
      const textoFiltro = filtroInput.value.toLowerCase();
      const generoFiltro = filtroGenero.value.trim().toLowerCase();
      let encontrados = 0;

      filas.forEach(fila => {
        const nombre = fila.children[2].textContent.toLowerCase();
        const marca = fila.children[3].textContent.toLowerCase();
        const genero = fila.children[5].textContent.trim().toLowerCase();

        const textoCoincide = nombre.includes(textoFiltro) || marca.includes(textoFiltro);
        const generoCoincide = generoFiltro === '' || genero === generoFiltro;

        if (textoCoincide && generoCoincide) {
          fila.style.display = '';
          encontrados++;
        } else {
          fila.style.display = 'none';
        }
      });

      mensajeNoResultados.style.display = encontrados === 0 ? 'block' : 'none';
    }

    function ordenarPorPrecio(ascendente = true) {
      // Convertimos filas en array para ordenar
      const filasVisibles = filas.filter(fila => fila.style.display !== 'none');

      filasVisibles.sort((a, b) => {
        const precioA = parseFloat(a.children[7].textContent) || 0;
        const precioB = parseFloat(b.children[7].textContent) || 0;
        return ascendente ? precioA - precioB : precioB - precioA;
      });

      // Añadimos las filas ordenadas al tbody
      filasVisibles.forEach(fila => tabla.appendChild(fila));
    }

    if (filtroInput) {
      filtroInput.addEventListener('input', () => {
        filtrarProductos();
        // Después de filtrar, reordena para mantener el orden
        // Opcional: quitar ordenación para que respete orden original tras filtro
      });
    }

    if (filtroGenero) {
      filtroGenero.addEventListener('change', () => {
        filtrarProductos();
      });
    }

    if (btnPrecioAlto) {
      btnPrecioAlto.addEventListener('click', () => {
        ordenarPorPrecio(false); // Orden descendente (precio alto primero)
      });
    }

    if (btnPrecioBajo) {
      btnPrecioBajo.addEventListener('click', () => {
        ordenarPorPrecio(true); // Orden ascendente (precio bajo primero)
      });
    }

    // Inicialmente filtramos para mostrar los productos correctamente
    filtrarProductos();
  });

</script>
{% endblock %}